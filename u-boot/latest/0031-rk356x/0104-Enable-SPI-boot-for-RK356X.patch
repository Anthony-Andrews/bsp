From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: bsp <bsp@radxa.com>
Date: Thu, 18 May 2023 15:56:11 +0800
Subject: [PATCH] Enable SPI boot for RK356X

---
 arch/arm/dts/rk3566-radxa-cm3-io-u-boot.dtsi         |  9 +++++++++
 arch/arm/dts/rk3566-radxa-cm3-rpi-cm4-io-u-boot.dtsi |  9 +++++++++
 arch/arm/dts/rk3566-radxa-cm3-sodimm-io-u-boot.dtsi  |  9 +++++++++
 arch/arm/dts/rk3566-radxa-cm3-sodimm-io.dts          | 10 ++++++++++
 arch/arm/dts/rk3566-radxa-cm3.dtsi                   | 10 ++++++++++
 arch/arm/dts/rk3566-radxa-e23-u-boot.dtsi            |  9 +++++++++
 arch/arm/dts/rk3566-rock-3c-u-boot.dtsi              |  9 +++++++++
 arch/arm/dts/rk3568-radxa-cm3i.dtsi                  | 10 ++++++++++
 arch/arm/dts/rk3568-radxa-e25-u-boot.dtsi            |  9 +++++++++
 arch/arm/dts/rk3568-rock-3a-u-boot.dtsi              |  9 +++++++++
 arch/arm/dts/rk3568-rock-3a.dts                      | 10 ++++++++++
 arch/arm/dts/rk3568-rock-3b-u-boot.dtsi              |  9 +++++++++
 arch/arm/dts/rk3568-rock-3b.dts                      | 10 ++++++++++
 13 files changed, 122 insertions(+)

diff --git a/arch/arm/dts/rk3566-radxa-cm3-io-u-boot.dtsi b/arch/arm/dts/rk3566-radxa-cm3-io-u-boot.dtsi
index 589332503e7..7d364000aaf 100644
--- a/arch/arm/dts/rk3566-radxa-cm3-io-u-boot.dtsi
+++ b/arch/arm/dts/rk3566-radxa-cm3-io-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3566-radxa-cm3-rpi-cm4-io-u-boot.dtsi b/arch/arm/dts/rk3566-radxa-cm3-rpi-cm4-io-u-boot.dtsi
index 589332503e7..7d364000aaf 100644
--- a/arch/arm/dts/rk3566-radxa-cm3-rpi-cm4-io-u-boot.dtsi
+++ b/arch/arm/dts/rk3566-radxa-cm3-rpi-cm4-io-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3566-radxa-cm3-sodimm-io-u-boot.dtsi b/arch/arm/dts/rk3566-radxa-cm3-sodimm-io-u-boot.dtsi
index 2bacdc53bdf..73fcd686e92 100644
--- a/arch/arm/dts/rk3566-radxa-cm3-sodimm-io-u-boot.dtsi
+++ b/arch/arm/dts/rk3566-radxa-cm3-sodimm-io-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3566-radxa-cm3-sodimm-io.dts b/arch/arm/dts/rk3566-radxa-cm3-sodimm-io.dts
index b49a30221a9..e4bbdf32bd2 100644
--- a/arch/arm/dts/rk3566-radxa-cm3-sodimm-io.dts
+++ b/arch/arm/dts/rk3566-radxa-cm3-sodimm-io.dts
@@ -513,6 +513,16 @@
 	};
 };
 
+&sfc {
+	status = "okay";
+
+	spiflash: flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+	};
+};
+
 &uart1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&uart1m0_ctsn &uart1m0_rtsn &uart1m0_xfer>;
diff --git a/arch/arm/dts/rk3566-radxa-cm3.dtsi b/arch/arm/dts/rk3566-radxa-cm3.dtsi
index 45de2630bb5..c6d1cb5c8ef 100644
--- a/arch/arm/dts/rk3566-radxa-cm3.dtsi
+++ b/arch/arm/dts/rk3566-radxa-cm3.dtsi
@@ -391,6 +391,16 @@
 	status = "okay";
 };
 
+&sfc {
+	status = "okay";
+
+	spiflash: flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+	};
+};
+
 &uart1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&uart1m0_ctsn &uart1m0_rtsn &uart1m0_xfer>;
diff --git a/arch/arm/dts/rk3566-radxa-e23-u-boot.dtsi b/arch/arm/dts/rk3566-radxa-e23-u-boot.dtsi
index 589332503e7..7d364000aaf 100644
--- a/arch/arm/dts/rk3566-radxa-e23-u-boot.dtsi
+++ b/arch/arm/dts/rk3566-radxa-e23-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3566-rock-3c-u-boot.dtsi b/arch/arm/dts/rk3566-rock-3c-u-boot.dtsi
index 589332503e7..7d364000aaf 100644
--- a/arch/arm/dts/rk3566-rock-3c-u-boot.dtsi
+++ b/arch/arm/dts/rk3566-rock-3c-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3568-radxa-cm3i.dtsi b/arch/arm/dts/rk3568-radxa-cm3i.dtsi
index c50fbdd4868..3b4a7a6af38 100644
--- a/arch/arm/dts/rk3568-radxa-cm3i.dtsi
+++ b/arch/arm/dts/rk3568-radxa-cm3i.dtsi
@@ -392,6 +392,16 @@
 	status = "okay";
 };
 
+&sfc {
+	status = "okay";
+
+	spiflash: flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+	};
+};
+
 &tsadc {
 	rockchip,hw-tshut-mode = <1>;
 	rockchip,hw-tshut-polarity = <0>;
diff --git a/arch/arm/dts/rk3568-radxa-e25-u-boot.dtsi b/arch/arm/dts/rk3568-radxa-e25-u-boot.dtsi
index 2bacdc53bdf..73fcd686e92 100644
--- a/arch/arm/dts/rk3568-radxa-e25-u-boot.dtsi
+++ b/arch/arm/dts/rk3568-radxa-e25-u-boot.dtsi
@@ -7,8 +7,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
diff --git a/arch/arm/dts/rk3568-rock-3a-u-boot.dtsi b/arch/arm/dts/rk3568-rock-3a-u-boot.dtsi
index d35703886b8..0213e384f18 100644
--- a/arch/arm/dts/rk3568-rock-3a-u-boot.dtsi
+++ b/arch/arm/dts/rk3568-rock-3a-u-boot.dtsi
@@ -8,8 +8,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &sdhci {
diff --git a/arch/arm/dts/rk3568-rock-3a.dts b/arch/arm/dts/rk3568-rock-3a.dts
index 917f5b2b8aa..493f16da8ba 100644
--- a/arch/arm/dts/rk3568-rock-3a.dts
+++ b/arch/arm/dts/rk3568-rock-3a.dts
@@ -756,6 +756,16 @@
 	status = "okay";
 };
 
+&sfc {
+	status = "okay";
+
+	spiflash: flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+	};
+};
+
 &tsadc {
 	rockchip,hw-tshut-mode = <1>;
 	rockchip,hw-tshut-polarity = <0>;
diff --git a/arch/arm/dts/rk3568-rock-3b-u-boot.dtsi b/arch/arm/dts/rk3568-rock-3b-u-boot.dtsi
index e4fc298f30b..a932f149cbf 100644
--- a/arch/arm/dts/rk3568-rock-3b-u-boot.dtsi
+++ b/arch/arm/dts/rk3568-rock-3b-u-boot.dtsi
@@ -8,8 +8,22 @@
 
 / {
 	chosen {
+		u-boot,spl-boot-order = "same-as-spl", &spiflash, &sdhci, &sdmmc0;
 		stdout-path = &uart2;
 	};
+
+	config {
+		u-boot,spl-payload-offset = <0x800000>; /* @ 8MB */
+ 	};
+};
+
+&sfc {
+	u-boot,dm-pre-reloc;
+	sfc-no-dma;
+};
+
+&spiflash {
+	u-boot,dm-pre-reloc;
 };
 
 &sdmmc2 {
diff --git a/arch/arm/dts/rk3568-rock-3b.dts b/arch/arm/dts/rk3568-rock-3b.dts
index aea41611a92..79bc2829ebc 100644
--- a/arch/arm/dts/rk3568-rock-3b.dts
+++ b/arch/arm/dts/rk3568-rock-3b.dts
@@ -756,6 +756,16 @@
 	status = "okay";
 };
 
+&sfc {
+	status = "okay";
+
+	spiflash: flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+	};
+};
+
 &tsadc {
 	rockchip,hw-tshut-mode = <1>;
 	rockchip,hw-tshut-polarity = <0>;
-- 
2.40.1

